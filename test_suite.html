<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Automated Test Suite</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #0f0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #0f0;
            margin-bottom: 20px;
            text-align: center;
        }

        .test-section {
            background: #1a1a1a;
            border: 2px solid #0f0;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .test-item {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #666;
            background: #0d0d0d;
        }

        .test-item.pass {
            border-left-color: #0f0;
        }

        .test-item.fail {
            border-left-color: #f00;
            color: #f00;
        }

        .test-item.pending {
            border-left-color: #ff0;
            color: #ff0;
        }

        .status {
            font-weight: bold;
            display: inline-block;
            width: 80px;
        }

        .controls {
            text-align: center;
            margin: 20px 0;
        }

        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 10px;
            border-radius: 5px;
        }

        button:hover {
            background: #0d0;
        }

        .summary {
            background: #1a1a1a;
            border: 3px solid #0f0;
            padding: 20px;
            text-align: center;
            font-size: 20px;
            margin-top: 20px;
        }

        .summary.all-pass {
            border-color: #0f0;
        }

        .summary.has-fail {
            border-color: #f00;
            color: #f00;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üß™ ADMIN DASHBOARD - AUTOMATED TEST SUITE</h1>

        <div class="controls">
            <button onclick="runAllTests()">‚ñ∂ RUN ALL TESTS</button>
            <button onclick="location.reload()">üîÑ RESET</button>
        </div>

        <div id="results"></div>
        <div id="summary" class="summary" style="display:none;"></div>
    </div>

    <script>
        const supabaseUrl = 'https://pklaofjfpcrlgevxkozy.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrbGFvZmpmcGNybGdldnhrb3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNjY1MDcsImV4cCI6MjA4MDg0MjUwN30.sNg6OVLocM1D-bG9LXTlDSsy6s74oW1SQ89QWCMbOKE';
        const _supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

        const PERMISSIONS = {
            VIEW_MENU: 1 << 0,           // 1
            CREATE_MENU: 1 << 1,         // 2
            EDIT_MENU: 1 << 2,           // 4
            DELETE_MENU: 1 << 3,         // 8
            CREATE_CATEGORIES: 1 << 5,   // 32
            EDIT_CATEGORIES: 1 << 6,     // 64
            DELETE_CATEGORIES: 1 << 7,   // 128
            VIEW_STAFF: 1 << 8,          // 256
            CREATE_STAFF: 1 << 9,        // 512
            EDIT_STAFF: 1 << 10,         // 1024
            DELETE_STAFF: 1 << 11,       // 2048
            VIEW_ORDERS: 1 << 12,        // 4096
            UPDATE_ORDERS: 1 << 13,      // 8192
            DELETE_ORDERS: 1 << 14,      // 16384
            MANAGE_ROLES: 1 << 15,       // 32768
            VIEW_TABLES: 1 << 16,        // 65536
            MANAGE_TABLES: 1 << 17       // 131072
        };

        let testResults = [];

        function addTest(category, name, status, message = '') {
            testResults.push({ category, name, status, message });
            renderResults();
        }

        function renderResults() {
            const container = document.getElementById('results');
            const grouped = {};

            testResults.forEach(t => {
                if (!grouped[t.category]) grouped[t.category] = [];
                grouped[t.category].push(t);
            });

            let html = '';
            for (const [category, tests] of Object.entries(grouped)) {
                html += `<div class="test-section">
                    <h2>${category}</h2>`;
                tests.forEach(t => {
                    const icon = t.status === 'pass' ? '‚úÖ' : t.status === 'fail' ? '‚ùå' : '‚è≥';
                    html += `<div class="test-item ${t.status}">
                        <span class="status">${icon} ${t.status.toUpperCase()}</span>
                        ${t.name} ${t.message ? `<br><small>&nbsp;&nbsp;&nbsp;&nbsp;${t.message}</small>` : ''}
                    </div>`;
                });
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function showSummary() {
            const total = testResults.length;
            const passed = testResults.filter(t => t.status === 'pass').length;
            const failed = testResults.filter(t => t.status === 'fail').length;

            const summary = document.getElementById('summary');
            summary.style.display = 'block';
            summary.className = 'summary ' + (failed === 0 ? 'all-pass' : 'has-fail');
            summary.innerHTML = `
                <h2>TEST SUMMARY</h2>
                <p>Total: ${total} | Passed: ${passed} | Failed: ${failed}</p>
                <h3>${failed === 0 ? 'üéâ ALL TESTS PASSED!' : '‚ùå SOME TESTS FAILED'}</h3>
            `;
        }

        async function runAllTests() {
            testResults = [];
            document.getElementById('summary').style.display = 'none';

            // 1. Test Database Connectivity
            addTest('System', 'Database Connection', 'pending');
            try {
                const { data, error } = await _supabase.from('roles').select('count', { count: 'exact', head: true });
                if (!error) {
                    addTest('System', 'Database Connection', 'pass', 'Connected to Supabase');
                } else {
                    addTest('System', 'Database Connection', 'fail', error.message);
                    return;
                }
            } catch (e) {
                addTest('System', 'Database Connection', 'fail', e.message);
                return;
            }

            // 2. Test Role & Permission Setup
            addTest('Permissions', 'Check Roles Exist', 'pending');
            const { data: roles } = await _supabase.from('roles').select('*');
            if (roles && roles.length > 0) {
                addTest('Permissions', 'Check Roles Exist', 'pass', `Found ${roles.length} roles`);

                // Check each role has permissions
                roles.forEach(role => {
                    const hasPerms = role.permissions && role.permissions > 0;
                    addTest('Permissions', `Role "${role.name}" has permissions`,
                        hasPerms ? 'pass' : 'fail',
                        hasPerms ? `Permission value: ${role.permissions}` : 'No permissions set!');
                });
            } else {
                addTest('Permissions', 'Check Roles Exist', 'fail', 'No roles found!');
            }

            // 3. Test Staff Table
            addTest('Database', 'Staff Table Query', 'pending');
            const { data: staff, error: staffErr } = await _supabase.from('staff').select('*, roles(*)').limit(1);
            if (!staffErr) {
                addTest('Database', 'Staff Table Query', 'pass', 'Staff table accessible');
                if (staff && staff.length > 0 && staff[0].roles) {
                    addTest('Database', 'Staff-Role Relationship', 'pass', 'Staff linked to roles correctly');
                } else {
                    addTest('Database', 'Staff-Role Relationship', 'fail', 'Staff not linked to roles');
                }
            } else {
                addTest('Database', 'Staff Table Query', 'fail', staffErr.message);
            }

            // 4. Test Menu Items
            addTest('Features', 'Menu Items Table', 'pending');
            const { data: menu, error: menuErr } = await _supabase.from('menu_items').select('*').limit(1);
            if (!menuErr) {
                addTest('Features', 'Menu Items Table', 'pass', menu?.length > 0 ? 'Has menu items' : 'Table exists');
            } else {
                addTest('Features', 'Menu Items Table', 'fail', menuErr.message);
            }

            // 5. Test Orders
            addTest('Features', 'Orders Table', 'pending');
            const { data: orders, error: ordErr } = await _supabase.from('orders').select('*').limit(1);
            if (!ordErr) {
                addTest('Features', 'Orders Table', 'pass', 'Orders table accessible');
            } else {
                addTest('Features', 'Orders Table', 'fail', ordErr.message);
            }

            // 6. Test Permission Logic
            addTest('Logic', 'Permission Bit Flags', 'pending');
            const testPerms = 12545; // Staff permissions
            const hasViewMenu = (testPerms & PERMISSIONS.VIEW_MENU) !== 0;
            const hasCreateMenu = (testPerms & PERMISSIONS.CREATE_MENU) !== 0;
            const hasManageRoles = (testPerms & PERMISSIONS.MANAGE_ROLES) !== 0;

            const expectedResults = hasViewMenu && !hasCreateMenu && !hasManageRoles;
            if (expectedResults) {
                addTest('Logic', 'Permission Bit Flags', 'pass', 'Bitwise operations working correctly');
            } else {
                addTest('Logic', 'Permission Bit Flags', 'fail', 'Bitwise logic error!');
            }

            // 7. Test Full Permission Value (Owner)
            addTest('Logic', 'Owner Full Permissions', 'pending');
            const ownerPerms = 0xFFFFFFFF;
            const hasAllPerms = Object.values(PERMISSIONS).every(perm => (ownerPerms & perm) !== 0);
            addTest('Logic', 'Owner Full Permissions', hasAllPerms ? 'pass' : 'fail',
                hasAllPerms ? 'Owner has all permissions' : 'Owner missing permissions!');

            // 8. Test Each Permission Type
            const permTests = [
                { name: 'VIEW_MENU', value: PERMISSIONS.VIEW_MENU },
                { name: 'CREATE_MENU', value: PERMISSIONS.CREATE_MENU },
                { name: 'EDIT_MENU', value: PERMISSIONS.EDIT_MENU },
                { name: 'DELETE_MENU', value: PERMISSIONS.DELETE_MENU },
                { name: 'CREATE_STAFF', value: PERMISSIONS.CREATE_STAFF },
                { name: 'MANAGE_ROLES', value: PERMISSIONS.MANAGE_ROLES }
            ];

            permTests.forEach(pt => {
                const exists = pt.value > 0 && Number.isInteger(pt.value);
                addTest('Permission Constants', pt.name, exists ? 'pass' : 'fail', `Value: ${pt.value}`);
            });

            // 9. Test Authentication (without actually logging in)
            addTest('Authentication', 'Auth Session Check', 'pending');
            const { data: session } = await _supabase.auth.getSession();
            if (session) {
                addTest('Authentication', 'Auth Session Check', 'pass', 'Supabase auth working');
            } else {
                addTest('Authentication', 'Auth Session Check', 'pass', 'No session (expected when not logged in)');
            }

            // 10. Test Tables
            addTest('Features', 'Restaurant Tables', 'pending');
            const { data: tables, error: tablesErr } = await _supabase.from('restaurant_tables').select('*').limit(1);
            if (!tablesErr) {
                addTest('Features', 'Restaurant Tables', 'pass', 'Tables accessible');
            } else {
                addTest('Features', 'Restaurant Tables', 'fail', tablesErr.message);
            }

            showSummary();
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });
    </script>
</body>

</html>