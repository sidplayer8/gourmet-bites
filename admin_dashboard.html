<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gourmet Admin v2.0 FIXED</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #ff6600;
            --secondary: #1a1a2e;
            --bg: #16213e;
            --text: #e0e0e0;
            --card-bg: #1f2940;
            --danger: #ef4444;
            --success: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--secondary);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        .logo {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: #ccc;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 102, 0, 0.1);
            color: var(--primary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            margin-left: 250px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .content-section {
            animation: fadeIn 0.3s ease;
            display: none;
            /* Hidden by default */
        }

        .content-section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin: 10px 0;
        }

        .stat-label {
            color: #888;
            font-size: 14px;
        }

        button {
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        .table-container table {
            width: 100%;
            border-collapse: collapse;
            color: #ddd;
        }

        .table-container th {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid #333;
        }

        .table-container td {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Mobile Responsive */
        .hamburger {
            display: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--primary);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 90;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 15px;
            }

            .hamburger {
                display: block;
                margin-right: 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table-container {
                overflow-x: auto;
            }

            #tablesGrid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)) !important;
            }

            .sidebar-overlay.active {
                display: block;
            }
        }

        /* Custom Modal Styling */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 200;
        }

        .custom-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .custom-modal .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #444;
        }

        .custom-modal label {
            display: block;
            margin: 15px 0 5px 0;
            color: #aaa;
            font-weight: 500;
        }

        .custom-modal input[type="text"],
        .custom-modal input[type="number"],
        .custom-modal textarea,
        .custom-modal select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #1a1a1a;
            color: white;
            font-size: 14px;
        }

        .custom-modal textarea {
            resize: vertical;
            font-family: inherit;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--card-bg);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            animation: slideIn 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 400px;
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.warning {
            border-left: 4px solid #ffb020;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">üç¥ Gourmet Admin</div>
        <div class="nav-item active" onclick="showSection('dashboard')">üìä Dashboard</div>
        <div class="nav-item" onclick="showSection('orders')">üìû Calls (Orders)</div>
        <div class="nav-item" onclick="showSection('history')">üìú History</div>
        <div class="nav-item" onclick="showSection('menu')">üçî Menu Management</div>
        <div class="nav-item" onclick="showSection('staff')">üë• Staff</div>
        <div class="nav-item" onclick="showSection('roles')">üîê Roles</div>
        <div class="nav-item" onclick="showSection('tables')">ü™ë Tables</div>
        <div style="flex:1"></div>
        <div class="nav-item" onclick="logout()">üö™ Logout</div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div style="display:flex; align-items:center;">
                <div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>
                <h1 id="pageTitle">Dashboard</h1>
            </div>
            <div class="user-profile">
                <span id="adminName" style="display:none;">Loading...</span>
                <!-- Hidden on mobile via CSS if needed, or just simplified -->
                <div class="avatar">A</div>
            </div>
        </div>
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- SECTION: DASHBOARD -->
        <div id="dashboard-section" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Orders</div>
                    <div class="stat-value" id="stat-total-orders">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Tables</div>
                    <div class="stat-value" id="stat-active-tables">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Revenue (Est)</div>
                    <div class="stat-value" id="stat-revenue">$0.00</div>
                </div>
            </div>
        </div>

        <!-- SECTION: ORDERS -->
        <div id="orders-section" class="content-section">
            <div class="stat-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Incoming Orders</h3>
                    <label style="color:#aaa; font-size:14px; cursor:pointer;">
                        <input type="checkbox" id="showHistoryCb" onchange="fetchOrders()"> Show History
                    </label>
                </div>
                <div id="ordersList" style="margin-top:20px; color:#999;">Loading orders...</div>
            </div>
        </div>

        <!-- SECTION: MENU -->
        <div id="menu-section" class="content-section">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3>Menu Management</h3>
                <button class="btn-primary" onclick="openMenuModal()">+ Add New Item</button>
            </div>

            <!-- Two-column layout: Categories sidebar + Menu items -->
            <div style="display:grid; grid-template-columns: 250px 1fr; gap:20px;">
                <!-- Category Sidebar -->
                <div class="stat-card" style="padding:15px; height:fit-content;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h4 style="margin:0;">Categories</h4>
                        <button onclick="openCategoryModal()" class="btn-primary"
                            style="padding:6px 12px; font-size:13px;">+</button>
                    </div>
                    <div id="categorySidebar">
                        <p style="color:#666; font-size:13px;">Loading categories...</p>
                    </div>
                </div>

                <!-- Menu Items -->
                <div class="stat-card table-container" id="menuTableContainer">
                    <p>Loading menu...</p>
                </div>
            </div>
        </div>

        <!-- SECTION: STAFF -->
        <div id="staff-section" class="content-section">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3>Staff Management</h3>
                <button class="btn-primary" onclick="openStaffModal()">+ Add Staff</button>
            </div>
            <div class="stat-card table-container" id="staffTableContainer">
                <p>Loading staff...</p>
            </div>
        </div>

        <!-- SECTION: ROLES -->
        <div id="roles-section" class="content-section">
            <div class="stat-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="margin:0;">Roles & Permissions</h3>
                    <button class="btn-primary" onclick="openRoleModal()">+ Add New Role</button>
                </div>
                <div id="rolesList" style="margin-top:20px;">Loading roles...</div>
            </div>
        </div>

        <!-- SECTION: HISTORY -->
        <div id="history-section" class="content-section">
            <div class="stat-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3>Order History</h3>
                    <div style="display:flex; gap:10px;">
                        <select id="historyFilter" onchange="fetchHistory()"
                            style="padding:8px; border-radius:6px; border:1px solid #444; background:#111; color:white;">
                            <option value="all">All Orders</option>
                            <option value="completed">Completed Only</option>
                            <option value="cancelled">Cancelled Only</option>
                        </select>
                    </div>
                </div>
                <div id="historyList" style="margin-top:20px;">Loading history...</div>
            </div>
        </div>

        <!-- SECTION: TABLES -->
        <div id="tables-section" class="content-section">
            <div class="stat-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3>Restaurant Tables</h3>
                    <button class="btn-primary" onclick="initTables()">+ Reset/Init Tables</button>
                </div>
                <div id="tablesGrid"
                    style="display:grid; grid-template-columns:repeat(auto-fill, minmax(120px, 1fr)); gap:15px;">
                    Loading tables...
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Add/Edit Menu Item -->
    <div id="menuModal" class="custom-modal">
        <div class="modal-content">
            <h2 id="menuModalTitle">Add Menu Item</h2>
            <input type="hidden" id="menuItemId">

            <label>Name</label>
            <input type="text" id="menuName" placeholder="Item name">

            <label>Category</label>
            <select id="menuCategory" onchange="handleCategoryChange()">
                <option value="Appetizers">Appetizers</option>
                <option value="Mains">Mains</option>
                <option value="Desserts">Desserts</option>
                <option value="Drinks">Drinks</option>
                <option value="__custom__">+ Create New Category</option>
            </select>
            <input type="text" id="customCategory" placeholder="Enter new category name"
                style="display:none; margin-top:10px;">

            <label>Price</label>
            <input type="number" id="menuPrice" placeholder="0.00" step="0.01">

            <label>Description (Optional)</label>
            <textarea id="menuDescription" placeholder="Item description" rows="3"></textarea>

            <label>Image URL (Optional)</label>
            <input type="text" id="menuImageUrl" placeholder="https://...">

            <!-- Visibility Controls -->
            <div style="margin-top:15px; padding:15px; background:#1e293b; border-radius:8px;">
                <h4 style="margin:0 0 10px 0; color:#94a3b8;">Visibility & Availability</h4>

                <label style="display:flex; align-items:center; gap:10px; margin-bottom:10px; cursor:pointer;">
                    <input type="checkbox" id="menuIsPublic" checked>
                    <div>
                        <strong>üåê Show in Customer Menu (Public)</strong>
                        <div style="font-size:12px; color:#64748b;">Uncheck to hide from customers (admin-only view)
                        </div>
                    </div>
                </label>

                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <input type="checkbox" id="menuIsAvailable" checked>
                    <div>
                        <strong>‚úÖ In Stock (Available)</strong>
                        <div style="font-size:12px; color:#64748b;">Uncheck to mark as out of stock</div>
                    </div>
                </label>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="saveMenuItem()" class="btn-primary">Save</button>
                <button onclick="closeMenuModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Category Modal (Add/Edit) -->
    <div id="categoryModal" class="custom-modal">
        <div class="modal-content" style="max-width:400px;">
            <h2 id="categoryModalTitle">Add Category</h2>
            <input type="hidden" id="categoryItemId">

            <label>Category Name</label>
            <input type="text" id="categoryName" placeholder="e.g. Burgers, Drinks, Desserts">

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="saveCategoryItem()" class="btn-primary">Save</button>
                <button onclick="closeCategoryModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal - Redesigned -->
    <div id="confirmModal" class="custom-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.75); z-index:9999; align-items:center; justify-content:center;">
        <div
            style="max-width:420px; width:90%; padding:30px; background:#1e293b; border-radius:12px; border:2px solid rgba(239,68,68,0.3); box-shadow:0 20px 60px rgba(0,0,0,0.5);">
            <!-- Warning Icon -->
            <div
                style="width:60px; height:60px; margin:0 auto 18px; background:rgba(239,68,68,0.15); border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid var(--danger);">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2.5">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                    </path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </div>

            <!-- Title -->
            <h2 id="confirmTitle"
                style="text-align:center; margin-bottom:12px; font-size:20px; font-weight:600; color:white;">Confirm
                Action</h2>

            <!-- Message -->
            <p id="confirmMessage"
                style="color:#94a3b8; text-align:center; margin:0 0 24px 0; line-height:1.6; font-size:14px;"></p>

            <!-- Buttons -->
            <div style="display:flex; gap:10px;">
                <button id="confirmBtn" style="
                    flex:1;
                    padding:12px 20px;
                    background:var(--danger);
                    color:white;
                    border:none;
                    border-radius:6px;
                    font-weight:600;
                    font-size:14px;
                    cursor:pointer;
                    transition:all 0.2s;
                " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='var(--danger)'">
                    Delete
                </button>
                <button onclick="closeConfirmModal()" style="
                    flex:1;
                    padding:12px 20px;
                    background:rgba(255,255,255,0.08);
                    color:#e2e8f0;
                    border:1px solid rgba(255,255,255,0.1);
                    border-radius:6px;
                    font-weight:600;
                    font-size:14px;
                    cursor:pointer;
                    transition:all 0.2s;
                " onmouseover="this.style.background='rgba(255,255,255,0.12)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.08)'">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Role Management Modal -->
    <div id="roleModal" class="custom-modal" style="display:none; align-items:center; justify-content:center;">
        <div class="modal-content" style="max-width: 600px; margin:auto;">
            <h2 id="roleModalTitle">Create Role</h2>
            <input type="hidden" id="roleId">

            <label>Role Name</label>
            <input type="text" id="roleName" placeholder="Manager, Chef, Waiter, etc." required>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label>Role Color</label>
                    <input type="color" id="roleColor" value="#99AAB5">
                </div>
                <div>
                    <label>Position (Higher = More Authority)</label>
                    <input type="number" id="rolePosition" value="10" min="0" max="100">
                </div>
            </div>

            <h3 style="margin-top: 20px; margin-bottom: 10px;">Permissions</h3>
            <div
                style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; max-height: 350px; overflow-y: auto; padding: 20px; background: #1e293b; border-radius: 8px;">

                <!-- Menu Management -->
                <div>
                    <h4 style="color: #f59e0b; margin-bottom: 12px;">üìã Menu Management</h4>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="VIEW_MENU">
                        <span>View Menu</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="CREATE_MENU">
                        <span>Create Menu Items</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="EDIT_MENU">
                        <span>Edit Menu Items</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="DELETE_MENU">
                        <span>Delete Menu Items</span>
                    </label>
                </div>

                <!-- Category Management -->
                <div>
                    <h4 style="color: #8b5cf6; margin-bottom: 12px;">üè∑Ô∏è Category Management</h4>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="VIEW_CATEGORIES">
                        <span>View Categories</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="CREATE_CATEGORIES">
                        <span>Create Categories</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="EDIT_CATEGORIES">
                        <span>Edit Categories</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="DELETE_CATEGORIES">
                        <span>Delete Categories</span>
                    </label>
                </div>

                <!-- Staff Management -->
                <div>
                    <h4 style="color: #3b82f6; margin-bottom: 12px;">üë• Staff Management</h4>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="VIEW_STAFF">
                        <span>View Staff</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="CREATE_STAFF">
                        <span>Create Staff</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="EDIT_STAFF">
                        <span>Edit Staff</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="DELETE_STAFF">
                        <span>Remove Staff</span>
                    </label>
                </div>

                <!-- Order Management -->
                <div>
                    <h4 style="color: #10b981; margin-bottom: 12px;">üõí Order Management</h4>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="VIEW_ORDERS">
                        <span>View Orders</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="UPDATE_ORDERS">
                        <span>Update Orders</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="DELETE_ORDERS">
                        <span>Delete Orders</span>
                    </label>
                </div>

                <!-- Table Management -->
                <div>
                    <h4 style="color: #ec4899; margin-bottom: 12px;">ü™ë Table Management</h4>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="VIEW_TABLES">
                        <span>View Tables</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="MANAGE_TABLES">
                        <span>Manage Tables</span>
                    </label>
                </div>

                <!-- Analytics & Other -->
                <div>
                    <h4 style="color: #6366f1; margin-bottom: 12px;">üìä Other Permissions</h4>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="VIEW_ANALYTICS">
                        <span>View Analytics</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="MANAGE_ROLES">
                        <span>Manage Roles</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" data-perm="ADMINISTRATOR" id="adminCheckbox">
                        <span style="color: #ef4444; font-weight: bold;">‚ö†Ô∏è Administrator (Full Access)</span>
                    </label>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="saveRole()" class="btn-primary">Save Role</button>
                <button onclick="closeRoleModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Staff Creation Modal -->
    <div id="staffModal" class="custom-modal" style="display:none; align-items:center; justify-content:center;">
        <div class="modal-content" style="max-width: 500px; margin:auto;">
            <h2 id="staffModalTitle">Add Staff Member</h2>
            <input type="hidden" id="staffId">

            <label style="display:block; margin-bottom:8px; color:#e2e8f0; font-weight:500;">Full Name *</label>
            <input type="text" id="staffName" placeholder="John Doe" required
                style="width:100%; padding:12px; background:#1e293b; border:1px solid #334155; border-radius:8px; color:#fff; font-size:14px; margin-bottom:15px;">

            <label style="display:block; margin-bottom:8px; color:#e2e8f0; font-weight:500;">Email *</label>
            <input type="email" id="staffEmail" placeholder="john@restaurant.com" required
                style="width:100%; padding:12px; background:#1e293b; border:1px solid #334155; border-radius:8px; color:#fff; font-size:14px; margin-bottom:15px;">

            <label style="display:block; margin-bottom:8px; color:#e2e8f0; font-weight:500;">Phone Number
                (Optional)</label>
            <input type="tel" id="staffPhone" placeholder="+1234567890"
                style="width:100%; padding:12px; background:#1e293b; border:1px solid #334155; border-radius:8px; color:#fff; font-size:14px; margin-bottom:5px;">
            <small style="color:#94a3b8; margin-top:0; margin-bottom:15px; display:block;">If provided, staff can login
                with either email or phone</small>

            <label style="display:block; margin-bottom:8px; color:#e2e8f0; font-weight:500;">Assign Role *</label>
            <select id="staffRoleSelect" required
                style="width:100%; padding:12px; background:#1e293b; border:1px solid #334155; border-radius:8px; color:#fff; font-size:14px; margin-bottom:15px; cursor:pointer;">
                <option value="">Select a role...</option>
                <!-- Populated dynamically -->
            </select>

            <div
                style="background:#1e293b; border:1px solid #334155; border-radius:8px; padding:15px; margin-bottom:20px;">
                <p style="color:#94a3b8; font-size:13px; margin:0; line-height:1.6;">
                    ‚ÑπÔ∏è <strong style="color:#e2e8f0;">How staff login:</strong><br>
                    Staff members will use the regular customer login (Google or SMS). Once they login, they'll see
                    options for both Admin Dashboard and Customer Menu.
                </p>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="saveStaff()" class="btn-primary">Add Staff Member</button>
                <button onclick="closeStaffModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://pklaofjfpcrlgevxkozy.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrbGFvZmpmcGNybGdldnhrb3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNjY1MDcsImV4cCI6MjA4MDg0MjUwN30.sNg6OVLocM1D-bG9LXTlDSsy6s74oW1SQ89QWCMbOKE';
        let _supabase;

        try {
            _supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        } catch (e) {
            console.error('Supabase Init Fail', e);
            document.body.innerHTML = '<h3 style="color:white; padding:20px;">Error initializing database connection.</h3>';
        }

        // --- PERMISSION SYSTEM (Discord-style bitwise flags) ---
        const PERMISSIONS = {
            // Menu Management (1-8)
            VIEW_MENU: 1 << 0,         // 1
            CREATE_MENU: 1 << 1,       // 2
            EDIT_MENU: 1 << 2,         // 4
            DELETE_MENU: 1 << 3,       // 8

            // Category Management (16-128)
            VIEW_CATEGORIES: 1 << 4,   // 16
            CREATE_CATEGORIES: 1 << 5, // 32
            EDIT_CATEGORIES: 1 << 6,   // 64
            DELETE_CATEGORIES: 1 << 7, // 128

            // Staff Management (256-2048)
            VIEW_STAFF: 1 << 8,        // 256
            CREATE_STAFF: 1 << 9,      // 512
            EDIT_STAFF: 1 << 10,       // 1024
            DELETE_STAFF: 1 << 11,     // 2048

            // Order Management (4096-16384)
            VIEW_ORDERS: 1 << 12,      // 4096
            UPDATE_ORDERS: 1 << 13,    // 8192
            DELETE_ORDERS: 1 << 14,    // 16384

            // Role Management (32768)
            MANAGE_ROLES: 1 << 15,     // 32768

            // Table Management (65536-131072)
            VIEW_TABLES: 1 << 16,      // 65536
            MANAGE_TABLES: 1 << 17,    // 131072

            // Analytics (262144)
            VIEW_ANALYTICS: 1 << 18,   // 262144

            // System (1073741824)
            ADMINISTRATOR: 1 << 30     // 1073741824 - Full access
        };

        // Helper functions for permission checking
        function hasPermission(userPerms, requiredPerm) {
            // Check if user has specific permission
            return (userPerms & requiredPerm) === requiredPerm;
        }

        function addPermission(currentPerms, newPerm) {
            // Add permission using bitwise OR
            return currentPerms | newPerm;
        }

        function removePermission(currentPerms, perm) {
            // Remove permission using bitwise AND with NOT
            return currentPerms & ~perm;
        }

        function togglePermission(currentPerms, perm) {
            // Toggle permission using bitwise XOR
            return currentPerms ^ perm;
        }

        // Get permission name from value
        function getPermissionName(permValue) {
            for (const [name, value] of Object.entries(PERMISSIONS)) {
                if (value === permValue) return name;
            }
            return 'UNKNOWN';
        }

        // Store current user's permissions globally
        let currentUserPermissions = 0;

        // --- AUTH & INIT ---
        // === NAVIGATION ===
        function showSection(sectionId) {
                 ocument.querySelectorA            tent-section').forEach(s => s.styl                'none');
            const target = document.getElementById(sectionId + '-section');
                 f (target) target.style.display = 'block';
            document.                rAll('.nav-item').forEach(i => i.classList.r                e'));
            if (event && event.target) event.target.classList.add('active');
                const titles = {'dashboard':'Dashboard                Calls (Orders)', 'history':'H istory','men u':'Menu  Management','staf f':'Staff  Management ','role s':'Roles & Permis sions',' tables':'Tables'};
              document.getElemen tById('pa geTitle' ).t                 titles[sectionId] || 'Dashboard';
        }
        
        (async function checkAd            s(        // 1. Session Check
            const { data: { session } } = await _supabase.auth.getSession();
            let user = session?.user;

            // 2. LocalStorage Fallback
            if (!user) {
                const localAdmin = JSON.parse(localStorage.getItem('adminUser'));
                const localUser = JSON.parse(localStorage.getItem('user'));
                user = localAdmin || localUser;
            }

            if (!user || e                               localSt                );
                window.location.hr            gin                        }

            // T            ification Function
            function showT                , type = 'info') {
                const toas                .createElement('div');
                            assName = `toast ${type}`;
                    toast.textContent = message;
                    document.body.appen                                    setTimeout(                                toast.style.opacity = '0';
                          ast.style.transform = 'translateX(400px                                      eou            toast.remove(), 300);
                     , 3000);
            }

            function toggleSidebar()                       document.querySelector('.sidebar').classList.toggle('open');
                               t.querySelector('.sidebar-overlay'                toggle('active');
            }
                 function showSection(sectionId)                       // Auto-close sidebar on mobile
                if (window                    68) {
                    document.querySelector('.sidebar').classList.                ');                         docum                ector('.sidebar-overlay').classList.remove('active');
                     

                // Sidebar UI                     document.querySelectorAll('.nav-item').forEach(el => {
                    el.cla                e('ac                                              tContent.toLowerCase().includes(sectionId)) el.classList.add('active');
                });
                     // Content UI
                document.querySelectorAll('.c                on').forEach(el => el.classList.remove('activ                                           = document.getElementById(`${sectionId}-section`);
                if (target) target.classList.add('active                         // He                         document.getElementById('pageTitle')                 = sectionId.charAt(0).toUpperCase() + sect                1);

                // Fetch Data
                          ctionId === 'dashboard') fet                               if (sect                    s') fetchOrde                                  sectionId === 'history') fetchHistory();
                    if (sectionId === 'menu') {
                         etchCategories();
                    fetch                                }
                       (sectionId === 'staff') fetchSt                           if (sectionId === 'roles') fetchRoles();
                     f (sectionId === 'tables') fetchTables();
            }

            // --- TABLES ---
            asy                fetchTables() {
                const container = document.getElementBy                id');
                const {                     await _supabase.from('restaurant_tables').select('*').order('table_number');

                         rror) {                 xtC                ror loading tables'; return; }
                           ta || !data.length) {
                                       HTML = '<p>No tables found. Click "Reset/Init" to create the                                 return;
                }

                container.innerHTML = data.map(t => {
                    const isFree = t.status === 'available';
                    const color = isFree ? 'var(--success)' : 'var(--danger)';

                    return `
                <div onclick="toggleTable('${t.id}', '${t.status}')" style="
                    background: ${isFree ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; 
                    border: 2px solid ${color}; 
                    border-radius: 12px; 
                    padding: 20px; 
                    text-align: center; 
                    cursor: pointer;
                    transition: transform 0.2s;
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="            e:2            t-weight:bold; color:white;">T-${t.table_number}                               <div style="margin-top:5px; color:${color}; font-size:14px                t:bold;">${t.status.toUpperCase()}</div>
                </div>`;
                }).j                         }

                as            tion toggleTable(id, currentSt                            const newStatus = currentStatus === 'available' ? 't            'av            ;
                await _supaba                taurant_tables').update({ status: newStatus }).eq('id', id);
                              ables();
            }

            a                n initTables() {
                    document.getElementById('confirmModal').style.display = 'flex';
            }

            function                 Modal() {
                document.getElementById('confirmModal').style.display = 'none';
            }

                  ync function                     s() {
                closeConfirmModal();
                          seeds = Array.from({ length: 10 }, (_, i) => ({ table_number: i + 1, sta                ble' }));                     const { error } = await _supabase.from('restaurant_tabl                    s, { onConflict                be                               if (error) {
                    console.error                ting tables:', error);
                    showToast('Error creating tables. Check console for details.', 'error');
                    } else {
                        showToast('‚úì Tables created successfully!',                                     fetchTables();
                }
                               a                n u                atus(id, newStatus) {
                const { dat                 await _supabase.from('orders').update({ status: newStatus }).eq('id', id).select().single();
                if (error)                           console.error(                        r:', error);
                    showToast                             status', 'error');
                    return;
                                       // If order is done/canc                        able
                if (newStatus ==                     n                 'c                 // Changed 'do                leted' to match existing status
                    if (data.table_id) {
                                await _supabas            restaurant_tables')
                                .update({ status: 'available', current_order_id: null                                    .eq('id', data.table_id);
                                   bles(); // Refresh table view
                    }
                }

                fetchOrders();
                    showToast(`Order #${id.slic                    as ${newStatus}`, 'success');
                               // --- HISTORY ---
            as                    chHistory() {
                const conta                ent.getEl                    ryList');
                             ter = document.getElementById('historyFilter').value;

                                    _supabase.from('orders').select('*').order('cr                 ascending: false }).lim                             if (filter === 'completed') {
                                   ry.eq('s                ple                           } else if (filte                    ') {
                    query = query.eq('status', 'cancelled');
                } else {
                                       ing
                                       ry.in('status', ['completed', 'cancelled                         }

                            data: orders, error } = await query;

                if (error || !orders) {
                                 .innerHTML = '<p>Error loading history</p>';
                    return;
                }

                            rs.length === 0) {
                    container.innerHTML = '<p style="co                    lign:center; padding:40px;">No completed orders yet.</p>';
                    return;
                }

                container.innerHTML = orders.map(o => {
                    let items                               try { items = typeof o.item                     JSON.parse(o.items) : o.items; } catch (e) { }
                    const itemsStr = Array.isArray(items) ? items.map(i => `${i.quantity}x ${i.name}`).join(', ') : '';
                    const statusColor = o.status === 'completed' ? 'var(--success)' : '#666';
                    const tableBadge = o.table_number ? `<span style="background:#3b82f6; color:white; padding:2px 6px; border-radius:4px; font-size:12px; margin-left:8px;">Table ${o.table_number}</span>` : '';
                    const date = new Date(o.created_at);

                    return `
                <div class="stat-card" style="margin-bottom:10px; border-left:4px solid ${statusColor}; opacity:0.8;">
                    <div style="display:flex; justify-content:space-between;">
                        <div>
                            <strong>#${o.id.slice(0, 8)}...</strong> ${tableBadge} 
                            <span style="background:${statusColor}; color:white; padding:2px 8px; border-radius:4px; font-size:11px; margin-left:8px;">${o.status.toUpperCase()}</span>
                            <br>
                            <small>${date.toLocaleDateString()} ${date.toLocaleTimeString                br>
                                    <div style="margi            x; font-size:14px; color:#ccc;                }</div                                  ${o.custom_notes ? `<div style="margin-top:5px; font-size:12px; color:#aaa;">üìù                     }</div>` : ''}
                        </div>
                        <d                    lign:right;">
                            <                    size:18px; font-weight:bold;">$${Number(o.total_price                        div>
                                                       </div>
                                             }).join(''                    

                                             async function fetchStats() {
                                                                    await _supabase.from('orders').select('*', { count: 'exac                                           document.getElementById('stat-total-orders').textContent = count ||                                           ables that are currently 'taken'
                    const { data: takenTables,                     _supabase
                        .from('restaurant_tables')
                                          tatus')
                        .eq('status', 'taken');

                                   {
                                  e.error('Error fetching active tables:',                                              e {
                            console.log('Active tables qu                , takenTables);
                        document.getEleme                -active-tables').textContent = taken                th || 0;
                    }

                    const { data: orders } = aw                e.from('orders').select('total_price');
                    const sum = orders?.reduce((acc, o) => acc + (Numb                rice) || 0), 0) || 0;
                    document.getElementById('stat-rev                ontent = '$' + sum.toFixed(2);
                } catch (err) {
                           sole.error('fetchStats error:', err);
                                  }

            // --- ORDERS ---
            async function fet                
                const container = document.getElementById('ordersList')                      container.innerHTML = 'Loading...';
                // Fetch all, but we wi                ient-side for now or w                 DB side.
                const { data, error } = await _supabase.from('o                ct('*').order('created_at', { ascending:                               if (error) { container.textContent = 'Error: ' + error.message; return                         if (!data.length) { contai                L = '                .</p>'; return; }

                                  (Keep calculating from ALL data)
                document.getElementById('stat-total-orde                     = data.length;
                const revenue = data.reduce((acc, o) => a                    ice || 0                                   ment.getElementById('stat-revenue').textConten                    e.toFixed(2);

                     / Filter for Display
                const showingHistory = document.getElementById('showHi                    d;
                const activeOrders = data.filter(o => {
                    if (showingHistory) r                    == 'completed' || o.status === 'cancelled';
                    return o.status                                    });

                        activeOrders.length === 0) {
                    const msg = showingHistory ? "No history yet." : "No pending orders. All caught up! üéâ";
                    container.innerHTML = `<p style="p                    or:#aaa;">${msg}</p>`;
                    return;
                }

                container.innerHTML = activeOrders.map(o => {
                    let items = [];
                    try { items = typeof o.items === 'string' ? JSON.parse(o.items) : o.items; } catch (e) { }
                    const itemsStr = Array.isArray(items) ? items.map(i => `${i.quantity}x ${i.name}`).join(', ') : '';
                    // Since we only show pending, color is always generic or specific for pending
                    const color = '#ffb020';
                    const tableBadge = o.table_number ? `<span style="background:#3b82f6; color:white; padding:2px 6px; border-radius:4px; font-size:12px; margin-left:8px;">Table ${o.table_number}</span>` : '';

                    return `
                <div class="stat-card" style="margin-bottom:10px; border-left:4px solid ${color};">
                    <div style="display:flex; justify-content:space-between;">
                        <div>
                            <strong>#${o.id.slice(0, 8)}...</strong> ${tableBadge} <small>${new Date(o.created_at).toLocaleTimeString()}</small><br>
                            <div style="margin-top:5px; font-size:15px; color:white;">${itemsStr}</div>
                            ${o.custom_notes ? `<div style="margin-top:5px; font-size:12px; color:#aaa;">üìù ${o.custom_notes}</div>` : ''}
                        </div>
                        <div style="te                ht;">
                                    <div style="font-size:18px; font-weight                umber(o.total_price || 0).toFixed(2)}</div>
                                <div                in-top:10px;">
                                <button style="ba                (--success); color:white; border:none; padding:8px 12px            -ra            ; cursor:pointer; font            bold;" onclick="updateOrder('${o.id            pleted')">DONE</button>
                                    <button style="ba                (--card-bg); border:1px solid #444; color:#aaa; padding:8px 12px; border-radius:4px; cursor:poi                ck="updateOrd                    ancelled')">Cancel</button>
                                                                    /d                            </div>
                </                           }).join('');
                 

                       unc            ateOrder(id, status) {
                            ED 'confirm' dialog (The "Black Box")
                // Insta                              await _supabase.from('orders')                atus }).eq('id', id);
                fetchOrd                    h list -> Order will disappear
            }

            // --- CATEGORIES ---
            let selectedCa                    ull;
                   dow                Data = [];

            async function fetchCategories() {
                                , error } = await _supa                ategories').select('*').order('display_order');
                     f (error) {
                    console.error('Error fetching categories:', error);
                    return;
                }
                window._categoriesData = data || [];
                renderCategorySidebar();
                return data;
            }

            function renderCategorySidebar() {
                const container = document.getElementById('categorySidebar');
                const categories = window._categoriesData;

                if (!categories || categories.length === 0) {
                    container.innerHTML = '<p style="color:#666; font-size:13px; text-align:center;">No categories yet.</p>';
                    return;
                }

                le                iv style="display:flex; flex                    n; gap:5px;">';

                // "All" filter button
                    const allSelected = selectedCategoryFilter === null;
                         += `
                <div class="cat-filter" data-cat="__all__" style="
                          dding:10px 12px;
                    background:${allSelected ? 'rgba(255,102,0,0.2)' : 'transparent'};
                    border-left:3px solid ${allSelected ? 'var(--primary)' : 'transparent'};
                    border-radius:6px;
                    cursor:pointer;
                    display:flex;
                    justify-content:space-between;
                    align-items:center;
                    transition:all 0.2s;
                    font-weight:${allSelected ? 'bold' : 'normal'};
                ">
                    <span>All Items</span>
                </div>
            `;

                categories.forEach(cat => {
                    const isSelected = selectedCategoryFilter === cat.name;
                    // Escape category name for safe HTML attribute insertion
                    const escapedName = cat.name.replace(/"/g, '&quot;').replace(/'/g, '&#39;');

                    html += `
                    <div class="cat-filter" data-cat="${escapedName}" data-catid="${cat.id}" style="
                        padding:10px 12px;
                        background:${isSelected ? 'rgba(255,102,0,0.2)' : 'transparent'};
                        border-left:3px solid ${isSelected ? 'var(--primary)' : 'transparent'};
                        border-radius:6px;
                        cursor:pointer;
                        display:flex;
                        justify-content:space-between;
                        align-items:center;
                        transition:all 0.2s;
                        font-weight:${isSelected ? 'bold' : 'nor                                     
                                 >${cat.name}</span>
                            <div style="display:fle                >
                            <button class="cat-edit" dat                     data-name="${escapedName}"
                                    style="background:rgba(255,255,255,0.1); border:1px                        ccc; cursor:pointer; padding:4px 8px; border-ra                            ;"
                                title="                            ton>
                                                        data-id="${cat.id}" data-name="$                                                   style="background:rgb                        rd                        anger); color:var(--danger);                        ding:4px 8px; border-radius:4px; font-size:11px;"
                                            e="De                y">Del</button>
                        </div>
                           iv>
                `;
                });

                             </div>';
                container.innerHTML = html;

                // Attach event listeners
                               uerySelectorAll('.cat-filt                    => {
                    el.addEventLis                        > {
                                         lick was on a button                                                if (e.target.                        cat-edit') ||
                            e.target.classL                        l') ||
                            e.target.closest('.cat-edit') ||
                                e.target.closest(                                                             ; // Let button handlers                                          }
                                        el.dataset.cat;
                             ilterMenuByCategory(                        null : cat);
                    });
                        
                const editBtns                        lectorAll('.cat-edit');
                const delBtns = container.que                        del');

                console.l                    sten                tBtn            , '            tons and', delBtns.length, 'delete butto                           editBtns.forEach(btn => {
                                   tListener('click', (e) => {
                        e.stopPro                                        e.preventDefault();
                               st id = parseInt(btn.dataset.id);
                        co                dit button                    egory ID:', i                                console.log('VERSION: 2024-12-18-17:45 - Calling ope                    ;
                                      ryModal(id);
                    });
                        
                delBtns.forEach(                                 btn.addEven                    ',                                             topPropagati                                  e.preventDefault();
                            const id = parse                    id);
                               st                 ataset.name;
                                ole.log('Delete but            ked            egory:', name, 'ID:', id);
                            deleteCategoryConfirm(id, name);
                    });
                                        }

            function op                dal(id = null) {
                const modal = document.getE                categoryModal');
                const title = document.getElementBy                ModalTitle');                     const nameInput = document.getElementById('category                                            t =                tEleme                    ItemId');
                        (id) {
                                    
                    const categor                            ta.find(c => c.id ==                               if (category) {                             title.textCont                        ';
                                              category.name;
                        idInput.value =                                                     else {
                               mode
                    title.textContent = 'Add Category';
                    nameInp                                       idInput.value = '';                                        modal.cl                                         nameInput.focus();
            }

                         closeCategoryModal() {
                         ent.getElementById('categoryModal').classList.remove(                                            async function saveCa                                   const id =                    mentById('categoryItemId').value;
                const                ment.getElementB                    e').value.trim();

                if (!name                            showToast('Please enter a category name', 'error');
                                 n;
                    }

                try {
                        if (id) {
                        // Update                                      const { error } = await _supabase
                                .from('categories')
                                     te({ name })
                            .eq('id', id);
                            if (error) throw error;
                        show                ory updated successfully', 's                                  } else {
                            // Insert new
                        const max                .max(...window._categoriesData.map(c =>                 der || 0), 0);
                        const { err                 _supabase
                            .from('categories')
                                .insert({ name, display_order: maxOrd                                       if                    rror;
                                       st(            y added successfully', 'success                            }

                    closeCategoryModal();
                                  fetchCategories();
                    await fetc                Refresh menu to up                                   } ca                                    console.error('Save category error:', err);
                    showToast('Failed                     : ' + err.mess                                                                    // Custom confirm modal functions
            function showConfirm                            Confirm) {
                                          .getElementById('confirmModal');
                const ti                            entById('confirmTitle');
                        t messageEl = do                            onfirmMessage');
                const confirm                            tById('confirmBtn');

                titleEl.textConten                                              ex                ess                             modal.style.display = 'flex'; // Flex for ce                             // Remove old listeners an                e
                const n                 = confirmBtn            de(                           co            .parentNode.replaceChild(newC                onfirmBtn);

                newConfirmBtn.addEventListener('clic                                    closeConfirmModal();
                    onConfirm();                     });
            }

            f                eConfirmModal() {
                                ElementById('confirmModal').style.display = 'none';
                  
                  ync function deleteCategoryConfirm(id,                                                 (
                    'Delete Category',
                    `Delete categ                    \nNote:                 n t                 will keep their categor                                  async ()                                  try {
                                const { error } = await _supabase                        delete().eq('id', id);
                            if                         

                            showToast('Category "' + name + '                    cess');
                            await fetchCategories();
                        } catch                                             co                'Delete category error:', err);
                            showToast('Failed to delete: ' + err.message, 'error');
                                                  }
                                   }

            function filterMenuByCateg                                        selectedCategoryFilter = categoryName;
                renderCategorySidebar();
                fetchMenu();
                               // --- MENU ---

            async function fetchMenu() {
                const container = document.getElementById(                    ner');
                let query = _supabase.                        elect('*').order('category');

                // Apply category filter if selected
                if (selectedCategoryFilter) {
                            y = query.eq('category', selectedCategoryFilter);
                }

                const { data, error } = await query;

                                                     container.innerHTML = `<p style="color:red">Erro                    ge}</p>`;
                    return;
                }

                // Cache for                                window._menuData = data;

                           ta || data.length === 0) {
                    const msg = select                                             ? `No items in "${selectedCategory                    y.`
                        : 'No menu items yet. Click "+ Add New Item" to get started.';
                        container.innerHTML = `<p style="color:#666; text-align                    :40px;">${msg}</p>`;
                    return;
                }

                let html = `<table><thead><tr><th>Name</th><th>Category</th><th>Price</th><th>Availability</th><th>Actions</th></tr></thead><tbody>`;
                html += data.map(item => {
                    const availBadge = item.is_available !== false
                        ? '<span style="background:var(--success); color:white; padding:2px 8px; border-radius:4px; font-size:11px;">Available</span>'
                        : '<span style="background:#666; color:white; padding:2px 8px; border-radius:4px; font-size:11px;">Out of Stock</span>';
                    const publicBadge = item.is_public !== false
                        ? '<span style="background:#3b82f6; color:white; padding:2px 6px; border-radius:4px; f                x; margin-lef                ic</span>'
                                 pan style="background:#64748b                e; padding:2px 6px; border-radius:4px; font-size:10px                t:5px;">Hidden</span>';

                    // Check if categ                     (only if category list is loaded)
                           st categoriesLoaded = window._categoriesData && wind                        ength > 0;
                            t ca                 = ca                ed
                        ? window._categoriesData.some(cat                     item.category)
                                               xists if categories not loaded yet

                                        egory = (item.catego                    ists                egor            ate            ;
                    const categoryStyle = ca                 ? '#334' : '#666';

                    return `
                    <tr>
                    <td><strong>${item.name || 'Unn                ng></td>
                           ><span style="background:${categoryStyle}; padding                rder-radius:4px;">${displayCategory}</span></td>                         <td>$${Number(item.price || 0).toFixed(2                                <td>${availBadge} ${publicBadge}</td>
                        <td>
                        <button class="m                " data-id="${item.id}" style="color:var(--primary); back                 border:none; cursor:pointer; margin-right:10px;">Edit</butt                                <button class=                n" data-id="${item.id}" style="color:var(--danger); background:n                none; cursor:pointer;">Delete</b                               </td>
                </tr                  `;
                }).join('');
                         += '</tbody></table>';                     container.innerHTML = html;

                //                     teners to all edit/delete                             container.querySelecto                    -btn').forEach(btn => {
                            addEv                'click', () => {
                        const id = btn.dataset.                as string (UUID)
                        openMenuModal                              });
                });                      container.querySelectorAll('.menu-del                ch(btn => {
                    btn.addEve                click', () =>                               con                    set.id; // Keep as string (UUID)
                            deleteMenuItem(id);
                    });
                                    }

            async function openMenuModal(itemId =                             const modal = document.getElementById('menuModal                        const title = document.getElementById('men                                                         st
                               tElementById('menuItemId').value = '';
                                 lementById('menuName                                   document.g                                alue = '';
                                       ById('menuDe                                            docume                                Url').value =                            um                        menuIsPublic').c                                   document.getElementById('menuIsAvaila                        ;
                     //                    ry dropdown
                cons                     = document.                        Category');
                categorySelect.innerHTML = '';

                         e cached categories with null check
                const cats = wind                        | [];
                cats.forEach(cat => {
                                           ment.createElement('option');
                    option.value = cat.name;
                        option.textContent = cat.name;
                    categorySelect.appe                                     });

                // Add "Uncategorized" option for items wi                        s
                const uncatOption = document.createElement('option');
                              n.value =                                      uncatOption.textContent = 'Uncategorized'                                      ct.append                    n);

                           mId) {
                    // Edit mo                                   e.textContent = 'Edit Menu Item';
                        document.getElementById('me            ').            itemId;

                    // Find ite                 compare as string                    rt
                                     ndow._menuData?.find(i => i.id == itemId);

                    // If not found i                    rom database
                         f (!it                                  try {
                            const { data, error } = await _supabase
                                    .from('menu_items                                       .select('*')
                                               temId)
                                    .single();

                                if (!error && data) {
                                                                             }
                        } catc                                              co                'Er            hin            , err);
                        }
                        }

                    // Popu            m with item data
                        if (item) {
                            document.getElementById('menuName').value = item.name || '';                                      ent.getElementById('menuCategory').value                   y || '';
                        document.getElementById('menuPrice'                em.                
                        document.getElementById('menuDescription').value = item.                || '';
                            document.getElementById('menuImageUrl').value = item.image_url || '';
                        document.getElemen                    lic').ch                .is                false;
                        document.getElementById('menuIsAvailable').checked = item.is_available !== false;
                          else {
                        showToast('Error: Could not load item data', 'error');
                    }
                } else {
                    // Add mode
                    title.textContent = 'Add Menu Item';
                }

                // Show modal AFTER all data is loaded
                modal.style.display = 'flex';
            }

            async function deleteMenuItem(itemId) {
                showConfirmModal(
                    'Delete Menu Item',
                    'Are you sure you want to delete this menu item? This action cannot be un                                async () =>                               try {
                                    const { error } = await _supabas                _items').delete().eq('id', itemId);
                                       or) throw error;

                            showToa                    leted', 'succe                                              await fetchMenu(                               } catch (er                                     console.error('Delete menu item err                                            showToast('Failed to delete: ' + err.message, 'error');
                                                  }
                    );
            }

            // Expose globally for modal callbacks
            window.fe                    fetchMen                                   F ---
            async function f                                  const container = document.getElementById('staffTableContainer');
                /* 
                                 relies                 ey                               If 'roles' table exists                     : .select('*, roles(name)')
                */
                const { data, error }                     e.from('staff').select('*, roles(name)');

                if (error) {
                    container.innerHTML = `<p style="color:red">Error: ${error.message}. Make sure 'roles' relationship exists.</p>`;
                    return;
                }

                let html = `<table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Role</th><th>Actions</th></tr></thead><tbody>`;
                html += data.map(s => `
                <tr>
                    <td>${s.name || 'Unset'}</td>
                    <td>${s.email || '-'}</td>
                    <td>${s.phone || '-'}</td>
                    <td><span style="background:#334; padding:2px 6px; border-radius:4px;">${s.roles?.name || s.role_id}</span></td>
                    <td>
                        <button onclick="deleteStaff('${s.id}')" style="color:var(--danger); background:none; border:none; cursor:pointer;">Remove</button>
                    </td>
                </tr>
            `).join('');
                html += '</tbody></table>';
                container.innerHTML = html;
            }

            async function deleteStaf                            i            rm(            access for this staff member?')) {
                        await _supabase.from('staff').delete().eq('id', i                            fetchStaff();
                }
            }
                 // --- ROLES                     async function fetchRoles() {
                            ntainer = document.getElementById('rolesList');
                    const { data, error } = await _supabase.from('roles'                ).order('position', { ascending: false });
                            r) {
                    co                rHTML = `<p style="color: red;">Error loading roles: ${error.message}</p>`;
                        return;
                      
                if (!data ||                     0) {
                    containe                    p style="color:#666;">No roles created yet. Click "                    to create one.</p>';
                              ;
                }

                container.innerHTML = dat                                     const permCount = r.pe                            lit('1').length - 1; /                                         return `
                <div style="backgroun                                gin-bottom:10px; border-radius:8px; border-left:4px solid                                       <div style="display:flex; justify-content:space-between;                                                   <di                                   <strong style="font-size:16px; color:${r.color};">${r.name}</str                                     <div style="margin-top:5px; color:#94a3b8; font-s                                                Position: ${r.position} | ${permCount} permissions
                                                               </div>
                                                        p:                                                              pe                        )" s                var(--pri                    d:none; border:                    nter; padding:5px 10px;">Edit</butt                                        <button onclick="deleteRole('${r.id}')" style="color:va                 background:none; border:none; cursor:pointer; padding:5px 10px;                tton>
                                                       </div>
                </div>
                                   }).join('');
            }

            function openRoleModal(roleId = null) {
                          modal = document.getElementBy                                     const title = docu                        'rol                                        //                                document.getEle            ('r            value = '';
                                ElementById('roleName').value = '';
                document.            ntB            eColor').value = '#99AAB5';
                    document.getElementById('rolePosition').value = '10'                       // Uncheck all permissions
                document.quer                ('.perm-checkbox').forEach(cb => cb.checked = false);

                    if (roleId) {
                    // Edit mode - load role data
                          tle.textConte                    ;
                    document.getElementById('r                    roleId;
                                   d role from fetched data
                                   rom('roles').select('                 roleId).single()
                        .then(({ data: role, error                                         if (!error &&                                             document.getElementById('roleName').valu                e;
                                            ment.getElementById('roleColor').value = role.color;
                                    doc                        ('rolePosition').value =                                                     // Check permission                                      for (con                             of Object.entries(P                                                                        sion(role.permissions, permValue)) {
                                                                   cument.querySelecto                        mName}"]`);
                                                                ox.checked = true;
                                        }
                                    }
                            }
                                                           {
                                    de
                           le.textContent =                                    }

                // Ad                     for Administrator checkbox auto-check
                cons                bo            men            mentById('adminCheckbox');
                         dminCheckbox) {
                        adminCheckbox                    r('change', function () {
                        const allCheckboxes = document.querySelectorAll('.per                    adminCheckbox)                                                          cb => {
                            cb.checked = this.checked;
                                                    });
                                       modal.style.display = 'flex';
            }

                                leModal() {
                          nt.getElementByI                            play = 'none';
            }

                                        ) {
                const roleId = document.getElementBy                                              ns                ume            eme            roleName').value.trim();
                    const color = document.getElementById                ).value;
                const position = parseInt(do                ementById('rolePosition').value);

                if (!nam                             s                ease enter a role name', 'error');
                            rn;
                }

                // Calcula                ns from checked boxes
                let permissi                             document.querySelectorAll('.perm-check                ).forEach(cb => {
                        const permName = cb.dataset.perm;
                    permissions = addPermission(permis                    NS[permName]);
                });

                        {
                    const roleData = { name, color, posit                        
                    if (roleId) {
                        // Upda                                             co                            upabase.from('roles')
                                  pdate(roleData)
                            .eq('                                           if (error) th                                       showToast('Role updated s                                                  } else {
                             / Cr                                              const                 await _supabase.from('roles')
                            .insert([role                                     if (error            err                                showToast                ed successfully', 'success');
                    }

                                    eModal();
                                   );
                } catch (e                              console.error('Save role error:', err);
                                  'Failed to save role: ' + err.message, 'error');
                }                                async function deleteRole(roleId) {
                sh                                        'Delete Role',
                    'Are you su                    elete this role? Staff members wit                        d to be reassigned.',
                    async () => {
                            try {
                                            error                        .from('roles').delete().eq('id', roleId);
                                                        
                                 howToas                            ully', 'success');
                                fetchRoles();
                            } c                                             console.error(                        , err);
                            showToast('Failed to delete: ' + err.messa                                          }                         }
                                   }

                                 GEMENT ---
            function openStaff                        ) {
                const modal = document.getElementById('                                      con                ocument.getElementById('staff                ;

                // Reset f                        document.getElementById('staffId').value = '';
                     ocument.getElementById('staffName').value = '';
                                    entById('staffEmail').value = '';
                document.getElementById('staffPhone').valu                             // Populate role dropdown
                _supa                    ').select('id,name,color').order('position', { ascending: fal                              .then(({ data: roles, error }) => {
                                     ect = document.getElementById('staffRoleSelect');
                                       rHTML = '<option value="">Select a role...</option>';

                               (!error && roles) {
                                             Each(role => {
                                    const option = document.createElement('option');
                                            on.value = role.id;
                                    option.textContent = role.name;
                                        ct.appendChild(option);
                            });
                            }
                    });

                title.textContent =                     Staff Member' : 'Add Staff Member';
                modal.                    'flex';
            }

            function closeStaffModal()                       document.getElementById('staffModal').style.display = 'none';
            }

                        nction saveStaff() {
                async function sav                                                      cument.getElementById('staffName').value.trim();
                                    = documen                        affEmail').value.trim();
                    const pho                    tEl                    Phone').value.trim                            const role                t.g                d('staffRoleSelect').value;

                    if (!nam                || !roleId) {
                        sh                ase fill in all required fields',                                       return;
                        }

                    try {
                            const { error: staffError }                pabase.from('staff').insert([{
                                name,
                            email                                  phone: phone || null,
                                role_id: roleId
                            }]);

                        if (                throw staffError;

                                             added! ${name} can login using customer log                    

                        closeStaffModal();
                                     Staff();
                    } ca                                        console.error('Save staff error:', er                                showToast('Failed                     + err.message, 'error');
                    }
                                       // --- MODALS (Enhanced) ---
                function                    d) {
                    const modal                         tById('menuModal');
                                          window._menuData.fin                    d) : {};
                         document.getElementById('modalTitle                     i                nu                  New Item';
                    document                    'editItemId').value = id || '';
                    docume                    d('itemName').value = item.name || '';
                                 getElementById('itemPrice').value = item.price || '';
                        document.getElementById('itemCat').value = item.category || 'Mai                             document.getElementById('item                    em.image_url || '';

                                      splay = 'flex';
                                       function closeMenuModal() {
                    documen                        nuModal'                    = '                           }

                async function saveM                                    const id = docu                    yId('editItemId').value;
                                       cument.getElementById('itemName').value;
                                ice = parseFloat(document                        mPrice').value);
                                       = document.getElementById('itemCat'                                            mage_url = document.getElementById('i                    
                    if (!name || isNaN(price)) { alert                    alid name and price'); return; }

                        const payload = { name, price, category, image_ur                              if (id) {
                                           .from('menu_it                    load).eq('id', id);
                    } else {
                            await _supabase.from('menu_items').insert                                     }

                    closeMenuModal();
                    fetchMenu                             }

                // Expose functions globally for inlin                    rs
                window.openStaffModal = openStaffMo                         window.deleteStaff = deleteStaff;
                              ateOrder = updateOrder;
                window.showSect                    n;
                window.openMenuModal = openMenuMo                         window.deleteMenuItem = deleteMenuItem;
                               CategoryModal = openCategoryModal;
                window.fi                    ry = filterMen                                 wind                        
                // Debug: Log that fu                                        console.log('Global functions exposed:'                            openMenuModal: typ                        odal,
                    deleteMenuItem: typeof window.de                                 });                             GLOBAL MENU FUNCTIONS ---
                // These MUST be g                            s can access them

                function handleCategoryChange() {
                            t select = document.getElementById('menuCategory');
                                       ut = document.getElementById('customCategory');
                    if (sel                            _') {
                        customInput.style.display = 'block';
                               tomInput.focus();
                    } else {
                        custo                            none';
                    }
                }

                function openMenuM                        {
                        conso                        l called wit                        
                    const modal = do                    tBy                    
                    const title = docu                    yId('menuModalTitle');
                          nst categorySelect = documen                ByI                ory');

                                        al element:', modal);
                    console.lo                    :', title);

                                   ||                                       console.er                    tle not found!', { modal, title });
                                                        }

                    // Populate category dro                    ase  
                    categorySelect.innerHTML = '';
                                 ategoriesData.forEach(cat => {
                        const option = docu                    nt('option');
                        option.value = cat.name;
                                    extContent = cat.name;
                        categorySelect.appendChild(o                                });
                    // Add custom category option at end
                        const customOption = document.createElement('option');
                                    .value = '__custom__';
                    customOption.textConten                    w Category';
                    categorySelect.appendChild(customOption)                           // Res                                document.getElementById('menuItemId').                                                    El                    ame').value = '';                         document.getElementById('menuCategory').value = window._c                        me || ''                                           lementById('custom                        play =                                 d                        Id('cus                        = '';
                    document                        uPrice').value = '';
                                .getElementById('menu                        = '';
                                        entB                    l').va                                                              'menuIsPub                                              document.getElem                                hecked = true;

                                    {
                                                                                          Edit Menu Item';
                               ument.get                            ).value =                                      // Find item in cache
                                   tem = window._menuDa                                );
                                                                                           ByI                        = item.name || '';                                 document.getElementById(                        e = item.category || '';
                                                       ('menuPrice').value = item                                                  document.get                        cription').value = item.description                                        document.getElementById('                    al                age                                                    ment.getElementById('menuIsPublic').ch                .is_public !== false;
                                  cument.getElementById('menuIsAvailab                 = item.is_available !== false;
                            }
                    } else {
                             /  Add mode
                        titext = 'Add Menu Item';
                    }

                    console.log('About to show modal...');
                    modal.classList.add('show');
                    console.log('Modal shown');
                }

                function closeMenuModal() {
                    const modal = document.getElementById('menuModal');
                    modal.classList.remove('show');
                }

                async function saveMenuItem() {
                    const id = document.getElementById('menuItemId').value;
                    const name = document.getElementById('menuName').value.trim();
                    const categorySelect = document.getElementById('menuCategory').value;
                    const customCat = document.getElementById('customCategory').value.trim();
                    const category = categorySelect === '__custom__' ? customCat : categorySelect;
                    const price = parseFloat(document.getElementById('menuPrice').value) || 0;
                    const description = document.getElementById('menuDescription').value.trim();
                    const imageUrl = document.getElementById('menuImageUrl').value.trim();
                    const isPublic = document.getElementById('menuIsPublic').checked;
                    const isAvailable = document.getElementById('menuIsAvailable').checked;

                    if (!name) {
                        showToast('Please enter item name', 'error');
                        return;
                    }
                    if (!category) {
                        showToast('Please select or create a category', 'error');
                        return;
                    }

                    const payload = {
                        name,
                        category,
                        price,
                        description: description || null,
                        image_url: imageUrl || null,
                        is_public: isPublic,
                        is_available: isAvailable
                    };

                    try {
                        if (id) {
                            // Update
                            const { error } = await _supabase
                                .from('menu_items')
                                .update(payload)
                                .eq('id', id);
                            if (error) throw error;
                        } else {
                            // Insert
                            const { error } = await _supabase
                                .from('menu_items')
                                .insert(payload);
                            if (error) throw error;
                        }

                        closeMenuModal();
                        // Need to expose fetchMenu too!
                        if (typeof window.fetchMenuGlobal === 'function') {
                            window.fetchMenuGlobal();
                        }
                    } catch (err) {
                        console.error('Save error:', err);
                        alert('Failed to save: ' + err.message);
                    }
                }

                // Expose to window
                window.openMenuModal = openMenuModal;
                window.closeMenuModal = closeMenuModal;
                window.saveMenuItem = saveMenuItem;
                window.deleteMenuItem = deleteMenuItem;
                window.handleCategoryChange = handleCategoryChange;
            })(); // Close checkAdminAccess IIFE
    </script>
</body>

</html>