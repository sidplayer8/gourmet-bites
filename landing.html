<!DOCTYPE html>
<html>

<head>
    <title>Welcome - Gourmet Bites</title>
    <!-- Supabase for Staff check -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .landing-container {
            text-align: center;
            width: 100%;
            max-width: 600px;
            padding: 20px;
            display: none;
            /* Hidden by default */
        }

        h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .role-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
            margin: 20px 0;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 20px;
            text-decoration: none;
            color: white;
        }

        .role-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-5px);
            border-color: #ff6600;
        }

        .role-icon {
            font-size: 40px;
            background: rgba(255, 255, 255, 0.1);
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .role-info {
            text-align: left;
            flex: 1;
        }

        .role-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #ff6600;
        }

        .role-desc {
            font-size: 14px;
            color: #999;
        }
    </style>
</head>

<body>
    <div class="landing-container" id="contentArea">
        <h1>Welcome Back</h1>
        <p style="color:#999; margin-bottom:40px;" id="welcomeName">User</p>

        <!-- Customer Option -->
        <a href="#" onclick="goCustomer()" class="role-card">
            <div class="role-icon">üçî</div>
            <div class="role-info">
                <div class="role-title">Customer View</div>
                <div class="role-desc">Browse menu, place orders, and track status.</div>
            </div>
        </a>

        <!-- Staff Option -->
        <div id="staffLink" class="role-card" style="border-color:#ff6600;">
            <div class="role-icon">üë®‚Äçüç≥</div>
            <div class="role-info">
                <div class="role-title">Staff Dashboard</div>
                <div class="role-desc">Manage orders, update menu, and view reports.</div>
            </div>
        </div>

        <button onclick="logout()"
            style="margin-top:20px; background:none; border:none; color:#666; cursor:pointer; text-decoration:underline;">Logout</button>
    </div>

    <script>
        const supabaseUrl = 'https://pklaofjfpcrlgevxkozy.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrbGFvZmpmcGNybGdldnhrb3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNjY1MDcsImV4cCI6MjA4MDg0MjUwN30.sNg6OVLocM1D-bG9LXTlDSsy6s74oW1SQ89QWCMbOKE';

        let _supabase = null;
        if (window.supabase) {
            _supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        }

        // Check Auth immediately
        checkAuth();

        async function checkAuth() {
            const user = JSON.parse(localStorage.getItem('user'));

            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // === 1. ALLOWLIST BYPASS (Email & Phone) ===
            const allowedAdmins = ['sapsinfocomm22@gmail.com', '+6590214181'];
            const uEmail = user.email || (user.user && user.user.email);
            const uPhone = user.phone || (user.user && user.user.phone);

            if (allowedAdmins.includes(uEmail) || allowedAdmins.includes(uPhone)) {
                // Force Admin Access
                console.log('Allowlist Access Granted.');
                showStaffUI({ roles: { name: 'Owner' }, name: 'Admin' });
                return;
            }

            // === 2. DATABASE ROLE CHECK ===
            if (user.id && _supabase) {
                try {
                    const { data: staffMember, error } = await _supabase
                        .from('staff')
                        .select('*, roles(name)')
                        .eq('user_id', user.id)
                        .single();

                    if (staffMember) {
                        showStaffUI(staffMember);
                    } else {
                        // NOT STAFF -> INSTANT REDIRECT
                        goCustomer();
                    }
                } catch (err) {
                    console.error(err);
                    goCustomer();
                }
            } else {
                // No DB/ID -> Customer
                goCustomer();
            }
        }

        function goCustomer() {
            const user = JSON.parse(localStorage.getItem('user'));
            const target = user && user.id ? `menu.html?user=${user.id}` : 'menu.html';
            window.location.replace(target);
        }

        function showStaffUI(staffMember) {
            // Retrieve user name for display
            const user = JSON.parse(localStorage.getItem('user'));
            if (user) {
                document.getElementById('welcomeName').innerHTML = `
                    ${user.name || user.email || user.phone}
                `;
            }

            // Show Container
            document.getElementById('contentArea').style.display = 'block';

            // Configure Staff Link
            const staffLink = document.getElementById('staffLink');
            const roleName = staffMember.roles?.name || 'Staff';
            staffLink.querySelector('.role-title').textContent = roleName + ' Dashboard';

            staffLink.onclick = () => {
                localStorage.setItem('staffInfo', JSON.stringify(staffMember));
                window.location.href = 'admin_dashboard.html';
            };
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }
    </script>
</body>

</html>