<!DOCTYPE html>
<html>

<head>
    <title>Welcome - Gourmet Bites</title>
    <!-- Supabase for Staff check -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .landing-container {
            text-align: center;
            width: 100%;
            max-width: 600px;
            padding: 20px;
        }

        h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .role-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
            margin: 20px 0;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 20px;
            text-decoration: none;
            color: white;
        }

        .role-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-5px);
            border-color: #ff6600;
        }

        .role-icon {
            font-size: 40px;
            background: rgba(255, 255, 255, 0.1);
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .role-info {
            text-align: left;
            flex: 1;
        }

        .role-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #ff6600;
        }

        .role-desc {
            font-size: 14px;
            color: #999;
        }
    </style>
</head>

<body>
    <div class="landing-container">
        <h1>Welcome Back</h1>
        <p style="color:#999; margin-bottom:40px;" id="welcomeName">User</p>

        <!-- Customer Option -->
        <a href="menu.html" class="role-card">
            <div class="role-icon">üçî</div>
            <div class="role-info">
                <div class="role-title">Customer View</div>
                <div class="role-desc">Browse menu, place orders, and track status.</div>
            </div>
        </a>

        <!-- Staff Option (Hidden by default) -->
        <div id="staffLink" class="role-card" style="display:none; border-color:#ff6600;">
            <div class="role-icon">üë®‚Äçüç≥</div>
            <div class="role-info">
                <div class="role-title">Staff Dashboard</div>
                <div class="role-desc">Manage orders, update menu, and view reports.</div>
            </div>
        </div>

        <button onclick="logout()"
            style="margin-top:20px; background:none; border:none; color:#666; cursor:pointer; text-decoration:underline;">Logout</button>
    </div>

    <!-- Supabase Inline (Updated to use unpkg just in case) -->
    <!-- We need this to check the 'staff' table -->
    <script>
        const supabaseUrl = 'https://pklaofjfpcrlgevxkozy.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrbGFvZmpmcGNybGdldnhrb3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNjY1MDcsImV4cCI6MjA4MDg0MjUwN30.sNg6OVLocM1D-bG9LXTlDSsy6s74oW1SQ89QWCMbOKE';

        // Init Supabase
        let _supabase = null;
        if (window.supabase) {
            _supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        }

        // Check Auth using LocalStorage (Populated by Login Sync)
        checkAuth();

        async function checkAuth() {
            const user = JSON.parse(localStorage.getItem('user'));

            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // Display Name & ID
            renderUser(user);

            // Check Role (Using the ID we synced to DB)
            if (user.id && _supabase) {
                checkUserRole(user.id);
            } else {
                // Not staff, or no DB connection -> Customers go to menu automatically?
                // User said: "people who dont have admin they will just land to menu"
                // So let's auto-redirect if NOT staff check
                if (!user.id) window.location.href = 'menu.html';
            }
        }

        function renderUser(user) {
            document.getElementById('welcomeName').innerHTML = `
                ${user.name || user.email || user.phone} <br>
                <small style="font-size:12px; color:#555; background:#111; padding:2px 6px; border-radius:4px; user-select:all; cursor:pointer;" onclick="navigator.clipboard.writeText('${user.id}'); alert('Copied ID!')" title="Click to Copy ID">
                    ID: ${user.id} (Click to Copy)
                </small>
            `;
        }

        async function checkUserRole(userId) {
            try {
                // Query the 'staff' table
                const { data: staffMember, error } = await _supabase
                    .from('staff')
                    .select('*, roles(name)')
                    .eq('user_id', userId)
                    .single();

                if (staffMember) {
                    // IS STAFF: Show options
                    const staffLink = document.getElementById('staffLink');
                    staffLink.style.display = 'flex';
                    const roleName = staffMember.roles?.name || 'Staff';
                    staffLink.querySelector('.role-title').textContent = roleName + ' Dashboard';

                    staffLink.onclick = () => {
                        localStorage.setItem('staffInfo', JSON.stringify(staffMember));
                        window.location.href = 'admin_dashboard.html';
                    };
                } else {
                    // NOT STAFF: Auto-redirect to Menu
                    console.log('Non-staff user, redirecting to menu...');

                    const container = document.querySelector('.landing-container');
                    container.innerHTML = '<h2 style="color:white;">Redirecting to Menu...</h2>';

                    setTimeout(() => {
                        window.location.href = 'menu.html';
                    }, 800);
                }

            } catch (err) {
                console.error('Unexpected error checking role:', err);
                // Fallback to menu on error
                window.location.href = 'menu.html';
            }
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }
    </script>
</body>

</html>