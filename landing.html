<!DOCTYPE html>
<html>

<head>
    <title>Welcome - Gourmet Bites</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .landing-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            padding: 20px;
            text-align: center;
        }

        .role-card {
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 16px;
            padding: 24px;
            margin: 12px 0;
            width: 100%;
            max-width: 320px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            text-decoration: none;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .role-card:active {
            transform: scale(0.98);
            background: #252540;
        }

        .role-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .role-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #ff6600;
        }

        .role-desc {
            font-size: 14px;
            color: #999;
        }

        .logout-link {
            margin-top: 30px;
            color: #666;
            text-decoration: underline;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="landing-container">
        <h1 style="margin-bottom: 10px;">Welcome Back!</h1>
        <p style="color: #999; margin-bottom: 40px;" id="welcomeName">User</p>

        <a href="menu.html" class="role-card">
            <span class="role-icon">üçΩÔ∏è</span>
            <span class="role-title">Customer View</span>
            <span class="role-desc">Browse menu, order food, and dine-in</span>
        </a>

        <a href="admin_dashboard.html" class="role-card" id="staffLink" style="display:none; border-color: #ff6600;">
            <span class="role-icon">‚ö°</span>
            <span class="role-title">Staff Dashboard</span>
            <span class="role-desc">Manage orders, tables, and menu</span>
        </a>

        <div onclick="logout()" class="logout-link">Logout</div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-inline.js"></script>

    <script>
        // Check Auth using Supabase Session (Handles OAuth Redirects)
        handleSession();

        async function handleSession() {
            // 1. Check if we just came back from Google Login (URL hash)
            const { data: { session }, error } = await _supabase.auth.getSession();

            if (session) {
                // We have a live session! Update localStorage for legacy app compatibility
                const user = session.user;
                const legacyUser = {
                    id: user.id,
                    email: user.email,
                    phone: user.phone,
                    name: user.user_metadata.full_name || user.email
                };
                localStorage.setItem('user', JSON.stringify(legacyUser));

                // Update UI
                renderUser(legacyUser);
                checkUserRole(user.id);
            } else {
                // No session? Check localStorage fallback or redirect
                const local = JSON.parse(localStorage.getItem('user'));
                if (local) {
                    renderUser(local);
                    checkUserRole(local.id);
                } else {
                    window.location.href = 'login.html';
                }
            }

            // Listen for auth changes (Logout, etc.)
            _supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_OUT') {
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                }
            });
        }

        function renderUser(user) {
            document.getElementById('welcomeName').innerHTML = `
                ${user.name || user.email || user.phone} <br>
                <small style="font-size:12px; color:#555; background:#111; padding:2px 6px; border-radius:4px; user-select:all; cursor:pointer;" onclick="navigator.clipboard.writeText('${user.id}'); alert('Copied ID!')" title="Click to Copy ID">
                    ID: ${user.id} (Click to Copy)
                </small>
            `;
        }

        // Renamed logout to use Supabase
        async function logout() {
            await _supabase.auth.signOut();
            localStorage.clear();
            window.location.href = 'login.html';
        }

        async function checkUserRole(userId) {
            try {
                // Query the 'staff' table to see if this user is a staff member
                // Also fetch the related role name
                const { data: staffMember, error } = await _supabase
                    .from('staff')
                    .select('*, roles(name)')
                    .eq('user_id', userId)
                    .single();

                if (error) {
                    // console.log('User is not staff or error:', error.message);
                    return;
                }

                if (staffMember) {
                    // User IS staff! Show the dashboard link.
                    const staffLink = document.getElementById('staffLink');
                    staffLink.style.display = 'flex';

                    // Update text with their specific role (e.g. "Owner Dashboard")
                    const roleName = staffMember.roles?.name || 'Staff';
                    staffLink.querySelector('.role-title').textContent = roleName + ' Dashboard';

                    // Allow click
                    staffLink.onclick = () => {
                        // Store staff info for the dashboard to use
                        localStorage.setItem('staffInfo', JSON.stringify(staffMember));
                        window.location.href = 'admin_dashboard.html';
                    };
                }

            } catch (err) {
                console.error('Unexpected error checking role:', err);
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }
    </script>
</body>

</html>