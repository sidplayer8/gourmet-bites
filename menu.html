<!DOCTYPE html>
<html>

<head>
    <title>Menu - Gourmet Bites</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="menu-page">
        <!-- Table Verification Modal -->
        <div id="tableModal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:9999; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px;">
            <div
                style="background:#1f2940; padding:30px; border-radius:16px; border:1px solid #ff6600; max-width:90%; width:400px;">
                <div style="font-size:40px; margin-bottom:15px;">🤳</div>
                <h2 style="color:white; margin-bottom:10px;">Welcome!</h2>
                <p style="color:#ccc; margin-bottom:20px;">Please scan the QR code on your table to view the menu and
                    order.</p>

                <!-- QR Scanner Area -->
                <div id="qrScanner" style="display:none; margin:20px 0;">
                    <div id="qrReader"
                        style="width:100%; max-width:300px; margin:0 auto; border-radius:8px; overflow:hidden;"></div>
                    <button onclick="stopScanner()"
                        style="margin-top:15px; padding:10px 20px; background:#666; color:white; border:none; border-radius:6px; cursor:pointer;">Close
                        Scanner</button>
                </div>

                <button id="startScanBtn" onclick="startScanner()"
                    style="width:100%; padding:15px; background:#ff6600; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:16px; margin-bottom:15px;">
                    📷 Scan QR Code
                </button>

                <div style="margin-top:20px; border-top:1px solid #333; padding-top:20px;">
                    <p style="font-size:12px; color:#666;">Scan with camera to continue.</p>
                </div>
            </div>
        </div>

        <div class="menu-header">
            <h1>Menu</h1>
            <div class="header-actions">
                <a href="profile.html" class="btn-profile">
                    <img id="profilePic" src="" alt="Profile" class="profile-pic">
                    <span id="userName">Profile</span>
                </a>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>

        <div id="categoryNav" class="category-nav">
            <!-- Categories will be loaded dynamically from database -->
        </div>

        <div id="menuView" class="menu-grid"></div>

        <div id="cartView" class="cart-page" style="display:none;">
            <h2>Your Cart</h2>
            <div id="cartItems"></div>
            <div class="cart-total">
                <h3>Total: <span id="cartTotal">$0.00</span></h3>
                <button class="btn-checkout" onclick="checkout()">Place Order</button>
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-btn active" onclick="showView('menu')">
                <span>🍽️</span>
                <span>Menu</span>
            </button>
            <button class="nav-btn" onclick="showView('cart')">
                <span style="position:relative;">
                    🛒
                    <span class="cart-badge"
                        style="position:absolute; top:-8px; right:-12px; background:#ff6600; color:white; border-radius:50%; width:20px; height:20px; font-size:11px; display:flex; align-items:center; justify-content:center; font-weight:bold;">0</span>
                </span>
                <span>Cart</span>
            </button>
        </div>
    </div>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- HTML5 QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <!-- Supabase inline config -->
    <script src="supabase-inline.js"></script>

    <!-- App logic -->
    <script src="app.js"></script>

    <script>
        let html5QrCode = null;

        function startScanner() {
            document.getElementById('startScanBtn').style.display = 'none';
            document.getElementById('qrScanner').style.display = 'block';

            html5QrCode = new Html5Qrcode("qrReader");

            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText, decodedResult) => {
                    // QR code scanned successfully
                    console.log(`QR Code detected: ${decodedText}`);

                    // Extract table_id from URL
                    try {
                        const url = new URL(decodedText);
                        const tableId = url.searchParams.get('table_id');

                        if (tableId) {
                            // Stop scanner and redirect
                            stopScanner();
                            window.location.href = decodedText;
                        } else {
                            alert('Invalid QR code. Please scan a valid table QR code.');
                        }
                    } catch (e) {
                        alert('Invalid QR code format.');
                    }
                },
                (errorMessage) => {
                    // Ignore scanning errors (they happen continuously while scanning)
                }
            ).catch((err) => {
                console.error('Camera error:', err);
                alert('Unable to access camera. Please check permissions or scan the QR code with your phone\'s camera app.');
                stopScanner();
            });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    html5QrCode = null;
                }).catch((err) => {
                    console.error('Error stopping scanner:', err);
                });
            }
            document.getElementById('startScanBtn').style.display = 'block';
            document.getElementById('qrScanner').style.display = 'none';
        }

        // Expose scanner functions globally
        window.startScanner = startScanner;
        window.stopScanner = stopScanner;

        // Load menu when page loads
        window.addEventListener('DOMContentLoaded', async () => {
            await loadCategories();
            if (typeof loadMenu === 'function') {
                loadMenu();
            }
        });

        // Load categories from database
        async function loadCategories() {
            try {
                // Wait for Supabase to be ready
                let attempts = 0;
                while (!window._supabase && attempts < 10) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (!window._supabase) {
                    console.error('Supabase client not available');
                    return;
                }

                const { data, error } = await window._supabase
                    .from('categories')
                    .select('*')
                    .order('display_order');

                if (error) {
                    console.error('Error loading categories:', error);
                    return;
                }

                const categoryNav = document.getElementById('categoryNav');
                if (!categoryNav) return;

                // Add "All" button
                let html = `
                    <button class="cat-btn active" onclick="filterMenu('All')"
                        style="background:none; border:none; color:white; padding:8px 16px; margin-right:8px; border-radius:20px; cursor:pointer; font-weight:bold;">
                        All
                    </button>
                `;

                // Add category buttons from database
                data.forEach(cat => {
                    html += `
                        <button class="cat-btn" onclick="filterMenu('${cat.name}')"
                            style="background:none; border:none; color:#999; padding:8px 16px; margin-right:8px; border-radius:20px; cursor:pointer;">
                            ${cat.name}
                        </button>
                    `;
                });

                categoryNav.innerHTML = html;
                console.log('Loaded', data.length, 'categories');
            } catch (err) {
                console.error('Failed to load categories:', err);
            }
        }

        // Set profile picture and name
        const user = JSON.parse(localStorage.getItem('user'));
        if (user) {
            const profilePic = document.getElementById('profilePic');
            const userName = document.getElementById('userName');

            // Construct fallback URL based on name or phone
            const displayName = user.name || user.phone || 'User';
            const fallbackUrl = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(displayName) + '&background=ff6600&color=fff&size=128';

            profilePic.onerror = function () {
                this.onerror = null;
                this.src = fallbackUrl;
            };

            if (user.photoURL && user.photoURL.trim() !== '') {
                profilePic.src = user.photoURL;
            } else {
                profilePic.src = fallbackUrl;
            }

            userName.textContent = displayName;
        }
    </script>
</body>

</html>